{
  "hash": "b639d40e7d34d387bf8851c37acd4bba",
  "result": {
    "markdown": "---\ntitle: \"R code for real data analysis\"\nsidebar: paper\nformat: \n  html:\n    code-fold: FALSE\n    code-tools: FALSE\neditor: visual\n---\n\n\n## 1. Loading datasets and correlation analysis\n\n::: {.cell}\n\n```{.r .cell-code}\n################################################################################################\n############################# Loading your Phyloseq object #####################################\n################################################################################################\n## WGS--------------------------------------------------------\nload(\"WGSphylo_w_tree.Rdata\")\nphylo_wgs = subset_samples(phy, diagnosis %in% c(\"cd\",\"uc\"))\nphylo_wgs = subset_taxa(phylo_wgs, kingdom==\"Bacteria\")\n\n# Filter to keep only taxa where the domain is 'Bacteria'\ntax_table_df <- as.data.frame(tax_table(physeq))\nbacteria_taxa <- tax_table_df[tax_table_df[, \"kingdom\"] == \"Bacteria\", ] ## Only keep Bacteria\nbacteria_ids <- rownames(bacteria_taxa)\nphylo_wgs <- prune_taxa(bacteria_ids, physeq)\n\ntax_table <- as.data.frame(tax_table(phylo_wgs))\ntax_table$phylum <- gsub(\"bacteriota$\",\"bacteria\", tax_table$phylum, perl = TRUE)\ntax_table$phylum <- gsub(\"bacterota$\",\"bacteria\", tax_table$phylum, perl = TRUE)\ntax_table$phylum <- gsub(\"etes$\",\"ota\", tax_table$phylum, perl = TRUE)\ntax_table$phylum <- gsub(\"bia$\",\"biota\", tax_table$phylum, perl = TRUE)\ntax_table$phylum <- gsub(\"chaota$\",\"chaetota\", tax_table$phylum, perl = TRUE)\ntax_table$phylum <- gsub(\"Deinococcus-Thermus$\",\"Deinococcota\", tax_table$phylum, perl = TRUE)\n\ntax_matrix <- as.matrix(tax_table)\ntax_table(phylo_wgs) <- tax_matrix\n\n# Now bacteria_phyloseq contains only bacterial data\nphyseq.wgs.genus = aggregate_taxa(phylo_wgs,level = \"genus\")\nphyseq.wgs.phylum = aggregate_taxa(phylo_wgs,level = \"phylum\")\n\n## 16s--------------------------------------------------------\nload(\"SixteenSphylo.Rdata\")\nphylo_16s = subset_samples(ps_amp_filter, diagnosis %in% c(\"uc\",\"cd\"))\nphylo_16s = subset_taxa(phylo_16s, Kingdom ==\"Bacteria\")\n\n# Filter to keep only taxa where the domain is 'Bacteria'\ntax_table_df <- as.data.frame(tax_table(physeq))\nbacteria_taxa <- tax_table_df[tax_table_df[, \"Domain\"] == \"Bacteria\", ] ## Only keep Bacteria\nbacteria_ids <- rownames(bacteria_taxa)\nphylo_16s <- prune_taxa(bacteria_ids, physeq)\n\ntax_table <- as.data.frame(tax_table(phylo_16s))\ntax_table$Phylum <- gsub(\"bacteriota$\",\"bacteria\", tax_table$Phylum, perl = TRUE)\ntax_table$Phylum <- gsub(\"bacterota$\",\"bacteria\", tax_table$Phylum, perl = TRUE)\ntax_matrix <- as.matrix(tax_table)\ntax_table(phylo_16s) <- tax_matrix\n\n\nphyseq.16s.genus = aggregate_taxa(phylo_16s,level = \"Genus\")\nphyseq.16s.phylum = aggregate_taxa(phylo_16s,level = \"Phylum\")\n\n\n## Common Features --------------------------------------------------------\nnumbers = lapply(c(1:7),function(level){\n  n1 = length(na.omit(unique(phylo_16s@tax_table[, level])))\n  n2 = length(na.omit(unique(phylo_wgs@tax_table[, level])))\n  n3 = length(intersect(na.omit(unique(phylo_wgs@tax_table[, level])),\n                        na.omit(unique(phylo_16s@tax_table[, level]))))\n  return(c(n1,n2,n3))\n})\n\nnumbers = data.frame(do.call(cbind,numbers))\ncolnames(numbers) =c(\"Domain\" ,\"Phylum\",\"Class\", \"Order\", \"Family\", \"Genus\",\"Species\")\nrownames(numbers) = c(\"16s\",\"wgs\",\"Overlap\")\nnumbers\n\n# Function to plot and save Venn\nplot_venn_save <- function(level, filename) {\n  only_16s <- numbers[\"16s\", level] - numbers[\"Overlap\", level]\n  only_wgs <- numbers[\"wgs\", level] - numbers[\"Overlap\", level]\n  overlap <- numbers[\"Overlap\", level]\n  \n  # Open PDF file\n  pdf(file = filename, width = 5, height = 3)  # You can adjust width/height\n  \n  # Plot Venn\n  VennDiagram::draw.pairwise.venn(\n    area1 = only_16s + overlap,\n    area2 = only_wgs + overlap,\n    cross.area = overlap,\n    category = c(\"\", \"\"),\n    fill = c(\"#ffa551\", \"#70afdf\"),\n    lty = \"blank\",\n    cex = 3,\n    cat.cex = 2,\n    cat.pos = c(-20, 20),\n    cat.dist = 0.05\n  )\n  \n  # Add the label on the left\n  grid.text(level, x = 0.12, y = 0.95, gp = gpar(fontsize = 24, fontface = \"bold\"))\n  \n  \n  # Close and save the PDF\n  dev.off()\n}\n\n# Example: Save the \"Genus\" Venn diagram\nplot_venn_save(\"Genus\", \"Genus_Venn.pdf\")\n###################################################################################################################\n################################# Common Genus Feature Correlations ###############################################\n###################################################################################################################\n## Check if OTU table samples order matches!!!\nall(colnames(physeq.16s.genus@otu_table) == colnames(physeq.wgs.genus@otu_table))\n\n## Transform to Relative Abundance\nphyseq.16s.genus.rel = transform_sample_counts(physeq.16s.genus, function(x) x / sum(x))\nphyseq.wgs.genus.rel = transform_sample_counts(physeq.wgs.genus, function(x) x / sum(x))\n\n## Common genus features from the most to least abundant\ngenus_16s = names(sort(taxa_sums(physeq.16s.genus.rel), TRUE))\ngenus_16s  = genus_16s[!grepl(\"Unknown\", genus_16s)]\n\ngenus_wgs = names(sort(taxa_sums(physeq.wgs.genus.rel), TRUE))\ngenus_wgs = genus_wgs[!grepl(\"Unknown\", genus_wgs)]\n\ncommon_genus = intersect(genus_16s,genus_wgs)\ncommon_genus_df =  data.frame(common = common_genus, \n                              SixS_Rank = match(common_genus, genus_16s),\n                              WGS_Rank = match(common_genus, genus_wgs))\n#write.csv(common_genus_df,file = \"Full_common_genus.csv\",row.names = FALSE)\n\n\n## Pearson Correlation ---------------------------------------------------------------------------\ncommon_genus_cor = lapply(common_genus, function(feature){\n  rel_abun_16s = as.vector(physeq.16s.genus.rel@otu_table[feature,])\n  rel_abun_wgs = as.vector(physeq.wgs.genus.rel@otu_table[feature,])\n  cor(rel_abun_16s, rel_abun_wgs)\n})\n\n## Distance Correlation ---------------------------------------------------------------------------\nlibrary(energy)\ncommon_genus_cor = lapply(common_genus, function(feature){\n  rel_abun_16s = as.vector(physeq.16s.genus.rel@otu_table[feature,])\n  rel_abun_wgs = as.vector(physeq.wgs.genus.rel@otu_table[feature,])\n  dcor(rel_abun_16s, rel_abun_wgs)\n})\n\n## Correlation Plot ------------------------------------------------------------------------------\ncommon_genus_cor = do.call(rbind,common_genus_cor)\ncommon_genus_cor_df = data.frame(Genus = common_genus,Corr = common_genus_cor)\n\nlibrary(viridis)\ncolor_palette = viridis_pal()(length(unique(common_genus_cor_df$Genus)))\ncommon_genus_cor_df$Genus = factor(common_genus_cor_df$Genus, levels = common_genus_cor_df$Genus)\n\ncorr_plot = ggplot(data=common_genus_cor_df, aes(x=Genus, y=Corr,fill = Genus)) +\n  geom_bar(stat=\"identity\")+\n  scale_fill_manual(values = color_palette) +  \n  labs(x = NULL, y = \"Correlation\",title = \"Common Genera\")  +\n  theme(legend.position = \"right\",axis.title.x = element_blank(),  \n        axis.text.x = element_blank()) \n\n#ggsave(\"Real_Plots/genus_dcorr_plot.pdf\",corr_plot,height = 5,width = 20)\n\n\n## Feature-wise scatter plot ---------------------------------------------------------------------\nMost_Abun_Genus = as.character(common_genus_cor_df[1:50,\"Genus\"])\n\nMost_Abun_Genus_Plots = lapply(Most_Abun_Genus, function(feature){\n  feature_df = data.frame(rel_16s = as.vector(physeq.16s.genus.rel@otu_table[feature,]),\n                          rel_wgs = as.vector(physeq.wgs.genus.rel@otu_table[feature,]))\n  limit = max(feature_df)\n  cor_value = round(common_genus_cor_df[which(common_genus_cor_df$Genus == feature),\"Corr\"],2)\n  ggplot(feature_df, aes(x=rel_16s, y=rel_wgs))  + \n    geom_point() +\n    geom_smooth(method=lm) +\n    theme_classic()+\n    labs(title = paste0(feature))+\n    ylim(0, limit)+\n    xlim(0, limit)+\n    annotate(\"text\",x = 0, y = limit,label = paste0(\"r=\", cor_value),hjust = -0.1, vjust = 1.1,size = 5)\n})\n\nlibrary(patchwork)\nCombined_Plots <- wrap_plots(Most_Abun_Genus_Plots, ncol = 10)\n\n#ggsave(\"Real_Plots/Most_Abun_Genus_Plots.pdf\",Combined_Plots,height = 10,width = 20)\n\n\n\n###################################################################################################################\n################################# Common Phylum Feature Correlations ###############################################\n###################################################################################################################\n## Check if OTU table samples order matches!!!\nall(colnames(physeq.16s.phylum@otu_table) == colnames(physeq.wgs.phylum@otu_table))\n\n## Transform to Relative Abundance\nphyseq.16s.phylum.rel = transform_sample_counts(physeq.16s.phylum, function(x) x / sum(x))\nphyseq.wgs.phylum.rel = transform_sample_counts(physeq.wgs.phylum, function(x) x / sum(x))\n\n## Common genus features from the most to least abundant\nphylum_16s = names(sort(taxa_sums(physeq.16s.phylum.rel), TRUE))\nphylum_16s  = phylum_16s [!grepl(\"Unknown\", phylum_16s)]\n\nphylum_wgs = names(sort(taxa_sums(physeq.wgs.phylum.rel), TRUE))\nphylum_wgs = phylum_wgs[!grepl(\"Unknown\", phylum_wgs)]\n\ncommon_phylum = intersect(phylum_16s,phylum_wgs)\n#save(common_phylum ,file = \"Full_common_phylum.Rdata\")\n\n## Pearson Correlation ---------------------------------------------------------------------------\ncommon_phylum_cor = lapply(common_phylum, function(feature){\n  rel_abun_16s = as.vector(physeq.16s.phylum.rel@otu_table[feature,])\n  rel_abun_wgs = as.vector(physeq.wgs.phylum.rel@otu_table[feature,])\n  cor(rel_abun_16s, rel_abun_wgs)\n})\n\n## Distance Correlation ---------------------------------------------------------------------------\nlibrary(energy)\ncommon_phylum_cor = lapply(common_phylum, function(feature){\n  rel_abun_16s = as.vector(physeq.16s.phylum.rel@otu_table[feature,])\n  rel_abun_wgs = as.vector(physeq.wgs.phylum.rel@otu_table[feature,])\n  dcor(rel_abun_16s, rel_abun_wgs)\n})\n\n## Correlation Plot ------------------------------------------------------------------------------\ncommon_phylum_cor = do.call(rbind,common_phylum_cor)\ncommon_phylum_cor_df = data.frame(Phylum = common_phylum,Corr = common_phylum_cor)\n\nlibrary(viridis)\ncolor_palette = viridis_pal()(length(unique(common_phylum_cor_df$Phylum)))\ncommon_phylum_cor_df$Phylum = factor(common_phylum_cor_df$Phylum, levels = common_phylum_cor_df$Phylum)\n\ncorr_plot = ggplot(data=common_phylum_cor_df, aes(x=Phylum, y=Corr,fill = Phylum)) +\n  geom_bar(stat=\"identity\")+\n  scale_fill_manual(values = color_palette) +  \n  labs(x = NULL, y = NULL)  +\n  ylim(-0.05,1)+\n  theme_minimal()+\n  theme(legend.position = \"right\",\n        legend.text = element_text(size = 8),\n        legend.key.size = unit(0.3, \"cm\"),\n        axis.title.x = element_blank(),  \n        axis.text.x = element_blank(),\n        panel.grid = element_blank(),\n        axis.line = element_line(color = \"black\")) \n\nggsave(\"Real_Plots/phylum_corr_plot.pdf\",corr_plot,height = 2,width = 4)\n\n\n\n\n## Plot of Most Abundant Features\nMost_Abun_Phylum = as.character(common_phylum_cor_df[,\"Phylum\"])\n\nMost_Abun_Phylum_Plots = lapply(Most_Abun_Phylum, function(feature){\n  feature_df = data.frame(rel_16s = as.vector(physeq.16s.phylum.rel@otu_table[feature,]),\n                          rel_wgs = as.vector(physeq.wgs.phylum.rel@otu_table[feature,]))\n  limit = max(feature_df)\n  cor_value = round(common_phylum_cor_df[which(common_phylum_cor_df$Phylum == feature),\"Corr\"],2)\n  ggplot(feature_df, aes(x=rel_16s, y=rel_wgs))  + \n    geom_point() +\n    geom_smooth(method=lm) +\n    theme_classic()+\n    labs(title = feature)+\n    ylim(0, limit)+\n    xlim(0, limit)+\n    annotate(\"text\",x = 0, y = limit,label = paste0(\"rho = \", cor_value),hjust = -0.1, vjust = 1.1,size = 5)\n})\n\nlibrary(patchwork)\nCombined_Plots <- wrap_plots(Most_Abun_Phylum_Plots, ncol = 6)\n```\n:::\n\n\n## 2. Diversity plot\n\n::: {.cell}\n\n```{.r .cell-code}\n## Alpha Diversity ----------------------------------------------------------------------------\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(patchwork)\nlibrary(vegan)\n\n# Rafefaction\nx = as.data.frame(t(otu_table(phylo_16s)))\npdf(\"Real_Plots/RF_16S.pdf\", width = 4, height = 3) # Width and height are in inches for PDFs\nrare_curve <- rarecurve(x, step = 2000, sample = 3000, col = \"blue\", cex = 0.6,label = FALSE,xlab =\"\")\ndev.off()\n\nx = as.data.frame(t(otu_table(phylo_wgs)))\npdf(\"Real_Plots/RF_WGS.pdf\", width = 4, height = 3) # Width and height are in inches for PDFs\nrare_curve <- rarecurve(x, step = 2000, sample = 40000, col = \"blue\", cex = 0.6,label = FALSE,xlab =\"\")\ndev.off()\n\n# Function to calculate alpha diversity and reshape data\nget_alpha_data <- function(physeq, sample_size, sequencing_type) {\n  # Rarefy and get metadata\n  physeq_rarefied <- rarefy_even_depth(physeq, sample.size = sample_size, rngseed = 2024)\n  meta <- meta(physeq_rarefied)\n  \n  # Calculate alpha diversity indices\n  Alp_ind <- alpha(physeq_rarefied, index = c(\"shannon\", \"inverse_simpson\", \"observed\"))\n  colnames(Alp_ind) <- c(\"observed\", \"shannon\", \"inverse_simpson\")\n  Alp_ind$diagnosis <- factor(meta$diagnosis)\n  Alp_ind$sequencing <- sequencing_type\n  \n  # Convert to long format\n  Alp_long <- Alp_ind %>%\n    pivot_longer(cols = c(\"observed\", \"shannon\", \"inverse_simpson\"), \n                 names_to = \"Index\", values_to = \"Diversity\")\n  \n  return(Alp_long)\n}\n\n# Get alpha diversity data for 16S\nalpha_16s <- get_alpha_data(phylo_16s, sample_size = 5000, sequencing_type = \"16S\")\n# Get alpha diversity data for WGS\nalpha_wgs <- get_alpha_data(phylo_wgs, sample_size = 30000, sequencing_type = \"WGS\")\n\n# Combine both datasets\nalpha_combined <- bind_rows(alpha_16s, alpha_wgs)\n\n# Function to perform Wilcoxon test and add p-values\nget_p_value <- function(data) {\n  test <- wilcox.test(Diversity ~ diagnosis, data = data, alternative = \"two.sided\")\n  return(round(test$p.value, 4))\n}\n\n# Add p-values to the data frame\np_values <- alpha_combined %>%\n  group_by(sequencing, Index) %>%\n  summarise(p_value = get_p_value(cur_data()))\n\n# Merge p-values into the combined data\nalpha_combined <- left_join(alpha_combined, p_values, by = c(\"sequencing\", \"Index\"))\ny = \n\ncorrelation_plot <- function(x, y) {\n  model <- lm(y ~ x)\n  sortx <- sort(x)\n  pred <- predict(model, newdata = data.frame(x = x_sorted), interval = \"confidence\")\n  \n  # Diversity Correlation heatscatter\n  heatscatter(x, y,\n              xlab = \"X\",                      # X label\n              ylab = \"Y\",                      # Y label\n              main = \"Correlation Plot\",       # Main title\n              color.palette = colorRampPalette(c(\"blue\", \"yellow\", \"red\")),  # Color gradient\n              cexplot = 1.5,                   # Point size\n              pch = 16,                        # Point shape (circle)\n              cex.lab = 1.5,                   # Axis label font size\n              cex.axis = 1.2,                  # Axis tick font size\n              cex.main = 1.5)                  # Title font size\n  \n  # Confidence band (shaded)\n  polygon(c(x_sorted, rev(x_sorted)),              # X coordinates\n          c(pred[, \"lwr\"], rev(pred[, \"upr\"])),    # Y coordinates\n          col = rgb(0.7, 0.7, 0.7, 0.4),            # Color and transparency\n          border = NA)                             # Remove border\n  \n  # Regression line\n  lines(x_sorted, pred[, \"fit\"], col = \"green\", lwd = 3)\n}\n\n# Plot using ggplot2 with facets\nlibrary(ggrain)\nalpha_plot <- ggplot(alpha_combined, aes(x = diagnosis, y = Diversity, fill = diagnosis)) +\n  geom_violin(trim = FALSE) +\n  geom_boxplot(width = 0.2, position = position_dodge(0.9), outlier.shape = NA) +\n  theme_classic() +\n  facet_grid(Index ~ sequencing, scales = \"free_y\") +\n  labs(x = NULL,y = \"Alpha Diversity\") +\n  theme(legend.position = \"bottom\",\n        panel.border = element_rect(color = \"black\", fill = NA, linewidth = 0.5),\n        strip.background = element_rect(color = \"black\", fill = \"gray90\")) +\n  # Annotate p-values in each facet\n  geom_text(\n    data = p_values, \n    aes(x = 1.5, y = Inf, label = paste0(\"p = \", formatC(p_value, format = \"f\", digits = 2))),\n    inherit.aes = FALSE, \n    vjust = 2, hjust = 0.5,size = 4\n  )\n\nalpha_plot <- ggplot(alpha_combined, aes(x = diagnosis, y = Diversity, fill = diagnosis)) +\n  geom_rain(violin.args = list(alpha = 0.7),\n            point.args = list(size = 0.3, alpha = 1)) +\n  scale_fill_manual(values = c(\"uc\" = \"#7AC3DF\", \"cd\" = \"#EB7E60\")) +\n  scale_color_manual(values = c(\"uc\" = \"#7AC3DF\", \"cd\" = \"#EB7E60\")) +\n  theme_classic() +\n  facet_grid(Index ~ sequencing, scales = \"free_y\") +\n  labs(x = NULL, y = NULL) +\n  theme(\n    legend.position = \"none\",\n    panel.border = element_rect(color = \"black\", fill = NA, linewidth = 1),\n    strip.background = element_blank(),     # Remove the grey boxes\n    # strip.background = element_rect(color = \"black\", fill = \"gray90\"),\n    # axis.text.y = element_blank(),     # Remove y-axis text\n    # axis.ticks.y = element_blank(),    # Remove y-axis ticks\n    axis.line = element_blank()\n  ) \nalpha_plot\n# Save the plot\nggsave(\"Real_Plots/Alpha_Diversity_combined.pdf\", alpha_plot, width = 5, height = 5)\n\n\n## Alpha Diversity Correlation----------------------------------------------------------------------------\nlibrary(energy)\nlibrary(XICOR)\nsample_names(phylo_16s) <- gsub(\"-16s$\", \"\", sample_names(phylo_16s))\nphyseq.16s = rarefy_even_depth(phylo_16s,sample.size = 5000,rngseed = 2024)\nphyseq.wgs = rarefy_even_depth(phylo_wgs,sample.size = 30000,rngseed = 2024)\ncommon_samples <- intersect(sample_names(physeq.16s), sample_names(physeq.wgs))\nphyseq.16s <- prune_samples(common_samples, physeq.16s)\nphyseq.wgs <- prune_samples(common_samples, physeq.wgs)\n\nAlp_ind_16s = alpha(physeq.16s,index = c(\"shannon\",\"inverse_simpson\",\"observed\"))\ncolnames(Alp_ind_16s) = c(\"observed\",\"shannon\",\"inverse_simpson\")\nAlp_ind_wgs = alpha(physeq.wgs,index = c(\"shannon\",\"inverse_simpson\",\"observed\"))\ncolnames(Alp_ind_wgs) = c(\"observed\",\"shannon\",\"inverse_simpson\")\nAlp_ind_wgs <- Alp_ind_wgs[match(rownames(Alp_ind_16s), rownames(Alp_ind_wgs)), ]\nall(rownames(Alp_ind_16s) == rownames(Alp_ind_wgs)) ## make sure order is matched\n\n \n# Step 1: Combine and reshape data\nindex_list <- c(\"observed\", \"shannon\", \"inverse_simpson\")\nlong_df <- do.call(rbind, lapply(index_list, function(index) {\n  data.frame(\n    Index = index,\n    Alp_16s = Alp_ind_16s[[index]],\n    Alp_wgs = Alp_ind_wgs[[index]]\n  )\n}))\n\nlong_df_observed <- long_df %>% filter(Index==\"observed\")\nx = long_df_observed$Alp_16s\ny = long_df_observed$Alp_wgs\np <- correlation_plot(x,y)\n\nplot_correlations_by_index <- function(df, index_col = \"Index\", x_col = \"Alp_16s\", y_col = \"Alp_wgs\", outdir = \".\") {\n  unique_indices <- unique(df[[index_col]])\n  \n  for (index in unique_indices) {\n    sub_df <- df %>% filter(.data[[index_col]] == index)\n    x <- sub_df[[x_col]]\n    y <- sub_df[[y_col]]\n    \n    # Create a safe filename\n    filename <- file.path(outdir, paste0(\"correlation_plot_\", gsub(\"[^A-Za-z0-9]\", \"_\", index), \".pdf\"))\n    \n    # Save to PDF\n    pdf(filename, width = 10, height = 6)\n    correlation_plot(x, y)\n    # title(main = paste(\"Correlation Plot -\", index))\n    dev.off()\n  }\n}\n\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(patchwork)\n\nplot_correlations_by_index <- function(df, index_col = \"Index\", x_col = \"Alp_16s\", y_col = \"Alp_wgs\", outdir = \".\") {\n  unique_indices <- unique(df[[index_col]])\n  \n  plot_list <- list()\n  \n  for (index in unique_indices) {\n    sub_df <- df %>% filter(.data[[index_col]] == index)\n    x <- sub_df[[x_col]]\n    y <- sub_df[[y_col]]\n    \n    # Generate plot with title\n    p <- correlation_plot(x, y)\n    \n    plot_list[[index]] <- p\n  }\n  \n  # Combine plots vertically (ncol = 1)\n  combined_plot <- wrap_plots(plot_list, ncol = 1)\n  \n  # Save combined plot\n  filename <- file.path(outdir, \"alpha_correlation_plots_combined.pdf\")\n  ggsave(filename, plot = combined_plot, width = 10, height = 6 * length(plot_list))\n}\n\n\n\nplot_correlations_by_index(long_df)\n\ncorrelation_plot <- function(x, y) {\n  par(bg=\"white\")\n  model <- lm(y ~ x)\n  x_sorted <- sort(x)\n  pred <- predict(model, newdata = data.frame(x = x_sorted), interval = \"confidence\")\n  \n  # Diversity Correlation heatscatter\n  heatscatter(x, y,\n              xlab = \" \",                      # X label\n              ylab = \" \",                      # Y label\n              main = \" \",       # Main title\n              color.palette = colorRampPalette(c(\"blue\", \"yellow\", \"red\")),  # Color gradient\n              cexplot = 1.2,                   # Point size\n              pch = 16,                        # Point shape (circle)\n              cex.lab = 1.5,                   # Axis label font size\n              cex.axis = 2,                  # Axis tick font size\n              cex.main = 1.5)                  # Title font size\n  \n  \n  # Confidence band (shaded)\n  polygon(c(x_sorted, rev(x_sorted)),              # X coordinates\n          c(pred[, \"lwr\"], rev(pred[, \"upr\"])),    # Y coordinates\n          col = rgb(0.7, 0.7, 0.7, 0.4),            # Color and transparency\n          border = NA)                             # Remove border\n  \n  # Regression line\n  lines(x_sorted, pred[, \"fit\"], col = \"green\", lwd = 3)\n  box(lwd=1.5)\n}\n\n\n# Step 2: Plot with facet_wrap\nCombined_Plots = ggplot(long_df, aes(x = Alp_16s, y = Alp_wgs)) +\n  geom_point(size = 0.5) +\n  geom_smooth(method = \"lm\", se = FALSE,color = \"#0098B9\") +\n  facet_wrap(~Index, scales = \"free\", ncol = 1) +\n  theme_classic() +\n  labs(x = \"16S\", y = \"Shotgun\", title = NULL)\n\n\nggsave(\"Real_Plots/Alpha_Diversity_Cor_1.pdf\",Combined_Plots ,width = 3,height = 4)\n\n## Beta Diversity-16s -----------------------------------------------------------------------\nlibrary(vegan)\n\nphyseq = transform_sample_counts(phylo_16s, function(x) x / sum(x))\nmeta = meta(physeq)\n\nBeta_plots1 = lapply(c(\"bray\",\"unifrac\",\"wunifrac\"), function(metric){\n  permanova_result <- adonis2(phyloseq::distance(physeq, method=metric) ~ diagnosis, \n                             data=data.frame(physeq@sam_data))\n  p_val <- permanova_result$\"Pr(>F)\"[1]\n  print(p_val)\n  ord = ordinate(physeq, method=\"PCoA\", distance = metric)\n  \n  eig_vals <- ord$values$Relative_eig * 100\n  xlab <- paste0(\"PCoA1 [\", round(eig_vals[1], 1), \"%]\")\n  ylab <- paste0(\"PCoA2 [\", round(eig_vals[2], 1), \"%]\")\n  \n  ord_df <- plot_ordination(physeq, ord, color = \"diagnosis\", justDF = TRUE)\n  \n  ggplot(ord_df, aes(x = Axis.1, y = Axis.2, color = diagnosis, fill = diagnosis)) +\n    geom_point(size = 0.5, alpha = 0.7) +  # control point size here\n    stat_ellipse(aes(group = diagnosis)) +\n    scale_fill_manual(values = c(\"uc\" = \"#7AC3DF\", \"cd\" = \"#EB7E60\")) +\n    scale_color_manual(values = c(\"uc\" = \"#7AC3DF\", \"cd\" = \"#EB7E60\")) +\n    theme_classic() +\n    labs(title = NULL,x = xlab, y = ylab) +\n    theme(\n      axis.ticks = element_blank(),\n      axis.text = element_blank(),\n      legend.position = \"none\"\n    )\n    # +annotate(\"text\", x = Inf, y = Inf, label = paste(\"p =\", round(p_val,2)), \n    #         hjust = 2, vjust = 1.1)\n    \n})\n## Beta Diversity-WGS -----------------------------------------------------------------------\nphyseq = transform_sample_counts(phylo_wgs, function(x) x / sum(x))\nmeta = meta(physeq)\n\nBeta_plots2 = lapply(c(\"bray\",\"unifrac\",\"wunifrac\"), function(metric){\n  permanova_result <- adonis2(phyloseq::distance(physeq, method=metric) ~ diagnosis, \n                             data=data.frame(physeq@sam_data))\n  p_val <- permanova_result$\"Pr(>F)\"[1]\n  print(p_val)\n  ord = ordinate(physeq, method=\"PCoA\", distance = metric)\n  \n  eig_vals <- ord$values$Relative_eig * 100\n  xlab <- paste0(\"PCoA1 [\", round(eig_vals[1], 1), \"%]\")\n  ylab <- paste0(\"PCoA2 [\", round(eig_vals[2], 1), \"%]\")\n  \n  ord_df <- plot_ordination(physeq, ord, color = \"diagnosis\", justDF = TRUE)\n  \n  ggplot(ord_df, aes(x = Axis.1, y = Axis.2, color = diagnosis, fill = diagnosis)) +\n    geom_point(size = 0.5, alpha = 0.7) +  # control point size here\n    stat_ellipse(aes(group = diagnosis)) +\n    scale_fill_manual(values = c(\"uc\" = \"#7AC3DF\", \"cd\" = \"#EB7E60\")) +\n    scale_color_manual(values = c(\"uc\" = \"#7AC3DF\", \"cd\" = \"#EB7E60\")) +\n    theme_classic() +\n    labs(title = NULL,x = xlab, y = ylab) +\n    theme(\n      axis.ticks = element_blank(),\n      axis.text = element_blank(),\n      legend.position = \"none\"\n    )\n  # +annotate(\"text\", x = Inf, y = Inf, label = paste(\"p =\", round(p_val,2)), \n  #         hjust = 2, vjust = 1.1)\n})\n\nBeta_plots = wrap_plots(c(Beta_plots1, Beta_plots2),ncol = 3,legend.position = \"none\")\nggsave(\"Real_Plots/Beta_Diversity.pdf\",Beta_plots,width = 5,height = 3.5)\n```\n:::\n\n\n## 3. Differential analysis and results visualization\n\n::: {.cell}\n\n```{.r .cell-code}\n## Univariate Results -----------------------------------------------------------------------\nphyseq = physeq.16s.genus\ncolnames(physeq@tax_table) = c(\"Kingdom\", \"Phylum\", \"Class\",\"Order\", \"Family\", \"Genus\", \"Species\")\nDA_taxa = c(\"Phylum\",\"Class\",\"Order\",\"Family\",\"Genus\")\ngroup = \"diagnosis\"\n\nlefse_results = run_lefse(physeq,group = group,norm = \"CPM\",kw_cutoff=1,wilcoxon_cutoff = 1,lda_cutoff=0,taxa_rank = \"Genus\")\naldex_results = run_aldex(physeq,group = group,p_adjust = \"BH\",pvalue_cutoff = 1)\nedger_results = run_edger(physeq,group = group,p_adjust = \"BH\",pvalue_cutoff = 1)\ndeseq2_results = run_deseq2(physeq,group = group,fitType = \"parametric\",sfType = \"poscounts\",p_adjust = \"BH\",pvalue_cutoff = 1)\nmetagenomeseq_results = run_metagenomeseq(physeq,group = group,p_adjust = \"BH\",pvalue_cutoff = 1,method = \"ZIG\")\nlimma_results = run_limma_voom(physeq,group = group,norm = \"none\",p_adjust = \"BH\",pvalue_cutoff =1)\nancombc_results = run_ancombc(physeq,group = group,p_adjust = \"BH\",pvalue_cutoff =1)\n\nout = list(lefse_results = lefse_results,aldex_results = aldex_results,\n           edger_results = edger_results,deseq2_results = deseq2_results,\n           metagenomeseq_results = metagenomeseq_results,\n           limma_results = limma_results,\n           ancombc_results = ancombc_results)\n\nsave(out,file = \"SixS_DA_results.Rdata\")\n\n\n## Visualization --------------------------------------------------------------------\nlibrary(reshape2)\nlibrary(dplyr)\nlibrary(tidyr)\nload(\"WGS_DA_results.Rdata\")\nDA_WGS = lefse_results\nload(\"SixS_DA_results.Rdata\")\nDA_16S = lefse_results\nrm(\"out\")\n\ndf_16S = as.data.frame(DA_16S@marker_table)           \ndf_16S$signed_lda <- ifelse(df_16S$enrich_group == \"uc\", df_16S$ef_lda, -df_16S$ef_lda)\ndf_16S$significant <- df_16S$pvalue < 0.05 & df_16S$ef_lda>=3\ndf_16S$platform = \"16S\"\nmatched_idx <- match(df_16S$feature, rownames(ctax_table_c))\ndf_16S$feature[!is.na(matched_idx)] <- ctax_table_c$genus[matched_idx[!is.na(matched_idx)]]\n\n  \ndf_WGS = as.data.frame(DA_WGS@marker_table)           \ndf_WGS$signed_lda <- ifelse(df_WGS$enrich_group == \"uc\", df_WGS$ef_lda, -df_WGS$ef_lda)\ndf_WGS$significant <- df_WGS$pvalue < 0.05 & df_WGS$ef_lda >= 3\ndf_WGS$platform = \"WGS\"\nmatched_idx <- match(df_WGS$feature, rownames(ctax_table_c1))\ndf_WGS$feature[!is.na(matched_idx)] <- ctax_table_c1$genus[matched_idx[!is.na(matched_idx)]]\n\n\nsig_16S <- df_16S$feature[df_16S$significant]\nsig_16S <- ctax_table_c$genus\nsig_WGS <- df_WGS$feature[df_WGS$significant]\nsig_WGS <- ctax_table_c1$genus\nall_common <- intersect(sig_16S,sig_WGS)\n\n# Replace p__Firmicutes with p__Bacillota\ndf_WGS$feature <- gsub(\"p__Firmicutes\", \"p__Bacillota\", df_WGS$feature)\n\n# Replace p__Proteobacteria with p__Pseudomonadota\ndf_WGS$feature <- gsub(\"p__Proteobacteria\", \"p__Pseudomonadota\", df_WGS$feature)\n\n\ndf <- rbind(df_16S, df_WGS) %>%\n  filter(significant) %>%\n  mutate(\n    group = case_when(\n      !(feature %in% all_common) & platform == \"16S\" ~ \"Unique-16S\",\n      !(feature %in% all_common) & platform == \"WGS\" ~ \"Unique-WGS\",\n      feature %in% all_common & feature %in% sig_16S & !(feature %in% sig_WGS) ~ \"Common-16S\",\n      feature %in% all_common & feature %in% sig_WGS & !(feature %in% sig_16S) ~ \"Common-WGS\",\n      feature %in% all_common & feature %in% sig_16S & feature %in% sig_WGS ~ \"Common-both\"\n    )\n  )\n\n\ndf$group <- factor(df$group, levels = c(\"Unique-16S\", \"Common-16S\", \"Common-both\", \"Common-WGS\", \"Unique-WGS\"))\n\ndf <- df %>%\n  arrange(group, desc(signed_lda)) %>%\n  mutate(feature = factor(feature, levels = rev(unique(feature))))\n\ndf$feature <- gsub(\"\\\\|\", \";\", df$feature)\ndf$feature <- gsub(\"k__Bacteria;\\\\|?\", \"\", df$feature)\n\nplot = ggplot(df, aes(x = signed_lda, y = feature, fill = platform)) +\n  geom_col(width = 0.6, position = position_dodge(width = 0.7)) +\n  geom_vline(xintercept = 0, color = \"gray40\", linetype = \"dashed\") +\n  scale_fill_manual(\n    values = c(\"16S\" = \"#ffa551\", \"WGS\" = \"#70afdf\")\n  ) +\n  xlim(-5,5)+\n  labs(x = NULL, y = NULL, fill = \"Platform\", title = NULL) +\n  theme_classic()+\n  theme(\n    axis.text.y = element_text(size = 15),\n    legend.position = \"none\",  # Top right inside plot\n    legend.justification = c(\"right\", \"top\"),\n    legend.background = element_rect(fill = \"white\", color = \"gray80\"),\n    panel.background = element_rect(fill = \"transparent\", color = NA),\n    plot.background = element_rect(fill = \"transparent\", color = NA)\n  )\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}